{% extends "layout.html" %}
{% block content %}

{% if warning %}
<div class="alert alert-warning mb-4">
    {{ warning }}
</div>
{% endif %}

<h3 class="fw-bold mb-4 text-danger">
    <i class="bi bi-exclamation-triangle-fill"></i>
    PHÂN TÍCH THỐNG KÊ TAI NẠN GIAO THÔNG TẠI MỸ
</h3>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-semibold mb-0">
        Thống kê mô tả các đặc trưng tai nạn
    </h5>
    <button id="togglePanelBtn"
            class="btn btn-sm btn-outline-secondary p-1 rounded-circle"
            style="width:30px; height:30px;"
            title="Tùy chọn hiển thị">
        <i class="bi bi-gear-fill"></i>
    </button>
</div>

<div id="controlPanel"
     class="card shadow-sm p-3 border-0 animate__animated animate__fadeIn"
     style="position:absolute; right:20px; top:80px; display:none; z-index:1000; width: 200px;">
    <h6 class="fw-bold text-center mb-3 text-primary border-bottom pb-2">Chế độ hiển thị</h6>

    <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="viewMode" id="optTable" checked>
        <label class="form-check-label fw-semibold" for="optTable"><i class="bi bi-table me-2"></i>Bảng số liệu</label>
    </div>

    <div class="form-check mb-2">
        <input class="form-check-input" type="radio" name="viewMode" id="optChart">
        <label class="form-check-label fw-semibold" for="optChart"><i class="bi bi-graph-up me-2"></i>Biểu đồ trực quan</label>
    </div>

    <div class="form-check">
        <input class="form-check-input" type="radio" name="viewMode" id="optBoth">
        <label class="form-check-label fw-semibold" for="optBoth"><i class="bi bi-grid-1x2 me-2"></i>Hiển thị tất cả</label>
    </div>
</div>

<div id="tableSection" class="card p-4 mb-4 shadow-sm border-0">
    <h5 class="text-primary mb-3"><i class="bi bi-table me-2"></i>Bảng thống kê chi tiết các thuộc tính số</h5>
    <div class="table-responsive">
        <table class="table table-hover table-bordered align-middle mb-0">
            <thead class="table-primary text-center text-nowrap">
                <tr>
                    <th>Thuộc tính</th>
                    <th>Số lượng</th>
                    <th>Trung bình (Mean)</th>
                    <th>Trung vị (Median)</th>
                    <th>Độ lệch chuẩn (Std)</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th>Độ lệch (Skewness)</th>
                    <th>Độ nhọn (Kurtosis)</th>
                </tr>
            </thead>
            <tbody>
                {% for row in stats %}
                <tr>
                    <td class="fw-bold text-primary text-start">{{ row.Feature }}</td>
                    <td class="text-center">{{ row.Count }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Mean) }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Median) }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Std) }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Min) }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Max) }}</td>
                    <td class="text-end {{ 'text-danger' if row.Skewness|abs > 1 else '' }}">{{ "%.2f"|format(row.Skewness) }}</td>
                    <td class="text-end">{{ "%.2f"|format(row.Kurtosis) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="chartSection" class="card p-4 shadow-sm border-0" style="display:none;">
    <h5 class="text-primary mb-4"><i class="bi bi-graph-up me-2"></i>Trực quan hóa dữ liệu</h5>
    <div class="row g-4">

        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white fw-bold text-center text-danger">
                    <i class="bi bi-pie-chart-fill me-2"></i>Phân bố mức độ nghiêm trọng (Label)
                </div>
                <div class="card-body p-2 d-flex align-items-center justify-content-center">
                    <img src="/images/severity_distribution.png" class="img-fluid rounded" alt="Severity Distribution" style="max-height: 400px;">
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-white fw-bold text-center text-dark">
                    <i class="bi bi-box-seam me-2"></i>Biểu đồ hộp: Khoảng cách tai nạn
                </div>
                <div class="card-body p-2 d-flex align-items-center justify-content-center">
                    <img src="/images/distance_boxplot.png" class="img-fluid rounded" alt="Distance Boxplot" style="max-height: 400px;">
                </div>
            </div>
        </div>

        <div class="col-12 mt-4">
            <h6 class="fw-bold text-secondary border-bottom pb-2"><i class="bi bi-bar-chart-steps me-2"></i>Phổ phân bố các đặc trưng số (Histograms)</h6>
        </div>

        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-2 text-center">
                    <small class="fw-bold text-secondary d-block mb-2">Nhiệt độ (°F)</small>
                    <img src="/images/Temperature(F)_hist.png" class="img-fluid rounded border" alt="Temp Hist">
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-2 text-center">
                    <small class="fw-bold text-secondary d-block mb-2">Độ ẩm (%)</small>
                    <img src="/images/Humidity(%)_hist.png" class="img-fluid rounded border" alt="Humidity Hist">
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card h-100 shadow-sm border-0">
                 <div class="card-body p-2 text-center">
                    <small class="fw-bold text-secondary d-block mb-2">Tốc độ gió (mph)</small>
                    <img src="/images/Wind_Speed(mph)_hist.png" class="img-fluid rounded border" alt="Wind Speed Hist">
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
                 <div class="card-body p-2 text-center">
                    <small class="fw-bold text-secondary d-block mb-2">Tầm nhìn (dặm)</small>
                    <img src="/images/Visibility(mi)_hist.png" class="img-fluid rounded border" alt="Visibility Hist" style="max-height: 300px;">
                </div>
            </div>
        </div>
         <div class="col-md-6">
             <div class="card h-100 shadow-sm border-0">
                <div class="card-body p-2 text-center">
                    <small class="fw-bold text-secondary d-block mb-2">Khoảng cách đoạn tai nạn (dặm)</small>
                    <img src="/images/Distance(mi)_hist.png" class="img-fluid rounded border" alt="Distance Hist" style="max-height: 300px;">
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const panel = document.getElementById("controlPanel");
const toggleBtn = document.getElementById("togglePanelBtn");
const table = document.getElementById("tableSection");
const chart = document.getElementById("chartSection");

// Toggle panel khi click nút setting
toggleBtn.onclick = (e) => {
    e.stopPropagation(); // Ngăn sự kiện click lan ra ngoài
    panel.style.display = panel.style.display === "block" ? "none" : "block";
};

// Ẩn panel khi click ra ngoài
document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && e.target !== toggleBtn) {
        panel.style.display = 'none';
    }
});

// Xử lý chuyển đổi chế độ xem
optTable.onchange = () => {
    table.style.display = "block";
    chart.style.display = "none";
    panel.style.display = "none"; // Tự động ẩn panel sau khi chọn
};

optChart.onchange = () => {
    table.style.display = "none";
    chart.style.display = "block";
    panel.style.display = "none";
};

optBoth.onchange = () => {
    table.style.display = "block";
    chart.style.display = "block";
    panel.style.display = "none";
};
</script>

{% endblock %}